#!/bin/bash
# Author name: Ruel Nopal
# Company: Nopla IT solution
# url: www.ruelnopal.com

# install wp cli
if [ -f /usr/local/bin/wp ]; then
  echo "Wp CLI is already installed in this machine!"
  wp --info

else
  echo "Installing WP CLI"
  sudo wget https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar

  echo "Change Permission of WP CLI"
  sudo chmod +x wp-cli.phar

  echo "Move wp-cli.phar /usr/local/bin/wp"
  sudo mv wp-cli.phar /usr/local/bin/wp

  wp --info
  echo "WP Cli Successfully Installed!"
fi

echo "Input the full path of your Wordpress installation folder..."
echo "If you don't know the detail, run <pwd> command from the Wordpress installation folder and the path will be output."
echo "It should be something like </home/user/wordpress> or </var/www/wordpress>"
path=$PWD
echo "Enter Wordpress Path: $path"

read wordpress_path
if [ -z "$wordpress_path" ]; then
  exit 1
fi

echo "Create a folder to store the important files?. The Default path is /"
echo "Input folder name: "

read folder_name
if [ -z "$folder_name" ]; then
  exit 1
fi

echo "Creating the folder /$folder_name ..."
mkdir /$folder_name
echo "Folder /$folder_name has been created"


echo "Moving the $wordpress_path/wp-content to the /$folder_name ..."
mv $wordpress_path/wp-content /$folder_name
echo "Successfully moved $wordpress_path/wp-content to /$folder_name"

echo "Moving $wordpress_path/wp-config.php to /$folder_name ..."
mv $wordpress_path/wp-config.php /$folder_name
echo "Successfully moved $wordpress_path/wp-config.php"

echo -e ""
echo -e ""
echo -e ""

echo "The next step requires the existing wordpress files to be delete."
echo "If you have important files that you don't have backup, please don't proceed."


read -p "Do you wish to proceed? [y/n] " yn
case $yn in
  [Yy]* ) rm -rf $wordpress_path/*; break;;
  * ) exit 1;;
esac


echo "Downloading fresh Wordpress files ..."
wget https://wordpress.org/latest.zip
echo "Download complete"

echo "Unzipping the Wordpress files ..."
unzip latest.zip
echo "Unzipping, complete"

echo "Moving the fresh Wordpress files to $wordpress_path ..."
mv wordpress/* $wordpress_path
echo "Moving of fresh Wordpress files, complete"

echo "Deleting default wp-content folder ..."
rm -rf $wordpress_path/wp-content
echo "Successfully deleted"

echo "Restoring the important files ..."
mv /$folder_name/wp-content /$folder_name/wp-config.php $wordpress_path
echo "Restoration complete"

echo "Cleaning un-utilized files/folders ..."
rm -rf latest.zip
rm -rf wordpress

echo "Updating and Removing Compromize Plugins."
echo "Note: this only update plugin that is available in wordpress Plugin Repository. For Plugin that is create by third party or premium plugin please refer to the creator and updta it on your own manually."

read -p "Do you wish to proceed? [y/n] " yn
case $yn in
  [Yy]* ) wp plugin update --all; break;;
  * ) exit 1;;
esac
wp plugin list --all

echo "Updating and Removing Compromize Theme."
echo "Note: this only update theme that is available in wordpress Plugin Repository. For Plugin that is create by third party or premium plugin please refer to the creator and updta it on your own manually."

read -p "Do you wish to proceed? [y/n] " yn
case $yn in
  [Yy]* ) wp theme update --all; break;;
  * ) exit 1;;
esac
wp theme list --all
sudo rm wp_malware_cleaner.sh
echo "Please check your site ..."
